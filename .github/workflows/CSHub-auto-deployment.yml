name: Daily Backup DB and Deploy CSHub Code to AWS EC2 with Docker Env (Code and Env Separated)

on:
  schedule:
    - cron: '0 8 * * *'  # Daily 02:00 CT（UTC 08:00）
  workflow_dispatch:
  
permissions:
  contents: write
  
jobs:
  dump_and_commit:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Install MySQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Dump the RDS schema "cshub"
        run: |
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          mkdir -p db_backup
          mysqldump \
            --host="${{ secrets.RDS_HOST }}" \
            --port=3306 \
            --user="${{ secrets.DB_USERNAME }}" \
            --password="${{ secrets.DB_PASSWORD }}" \
            "${{ secrets.DB_NAME }}" > "db_backup/${TIMESTAMP}.sql"

      - name: Delete old backups (7+ days)
        run: |
          if [ -d db_backup ]; then
            echo "Files to be removed:"
            current=$(date +%s)
            for file in db_backup/*.sql; do
              [ -e "$file" ] || continue
              base=$(basename "$file" .sql)
              file_date="${base%-*}"
              file_time="${base#*-}" 
              formatted_timestamp="${file_date:0:4}-${file_date:4:2}-${file_date:6:2} ${file_time:0:2}:${file_time:2:2}:${file_time:4:2}"
              file_timestamp=$(date -d "$formatted_timestamp" +%s 2>/dev/null) || continue
              age_days=$(( (current - file_timestamp) / 86400 ))
              if [ "$age_days" -ge 7 ]; then
                echo "Removing old backup: $file ($age_days days old)"
                rm "$file"
              fi
            done
          fi

      - name: Commit and push changes
        run: |
          git add db_backup
          git commit -m "Daily backup + cleanup on $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          git push

  deploy-to-ec2:
    name: Build & Deploy to EC2
    runs-on: ubuntu-latest
    needs: dump_and_commit  # Waiting for db backup

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Setup Scala and sbt
        uses: olafurpg/setup-scala@v10
        with:
          java-version: adopt@1.8

      - name: Clean Ivy and Coursier Cache
        run: |
          rm -rf /home/runner/.ivy2/cache/com.iheart
          rm -rf /home/runner/.ivy2/local/com.iheart
          rm -rf /home/runner/.cache/coursier/v1/https/repo1.maven.org/maven2/com/iheart

      - name: Compile, Stage, Dist Backend Project
        run: sbt clean compile stage dist
        working-directory: ./backend

      - name: Compile, Stage, Dist Frontend Project
        run: sbt clean compile stage dist
        working-directory: ./frontend

      - name: Remove RUNNING_PID for Frontend
        run: rm -f ./frontend/target/universal/stage/RUNNING_PID
        working-directory: ./frontend

      - name: Remove RUNNING_PID for Backend
        run: rm -f ./backend/target/universal/stage/RUNNING_PID
        working-directory: ./backend

      - name: Rename ZIPs for Upload
        run: |
          FRONT_ZIP=$(ls frontend/target/universal/*.zip | head -n 1)
          BACK_ZIP=$(ls backend/target/universal/*.zip | head -n 1)
          mv "$FRONT_ZIP" frontend.zip
          mv "$BACK_ZIP" backend.zip

      - name: Upload ZIPs to EC2 via SCP
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "$EC2_KEY" > ec2_key.pem
          chmod 600 ec2_key.pem
          scp -o StrictHostKeyChecking=no -i ec2_key.pem frontend.zip $EC2_USER@$EC2_HOST:/home/ubuntu/beichenh/scihub/
          scp -o StrictHostKeyChecking=no -i ec2_key.pem backend.zip $EC2_USER@$EC2_HOST:/home/ubuntu/beichenh/scihub/

      - name: SSH to EC2 and Deploy ZIPs with Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo apt-get update && sudo apt-get install -y unzip

            cd /home/ubuntu/beichenh/scihub

            rm -rf frontend-dist backend-dist
            unzip -o frontend.zip -d frontend-dist
            unzip -o backend.zip -d backend-dist

            sudo echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            sudo docker stop cshub-frontend-env || true && docker rm cshub-frontend-env || true
            sudo docker stop cshub-backend-env || true && docker rm cshub-backend-env || true
            sudo docker network create cshub-network || true

            docker run -d \
              -p 9036:9036 \
              --name cshub-frontend-env \
              --network cshub-network \
              -v /home/ubuntu/beichenh/scihub/frontend-dist:/app \
              -e BACKEND_HOST="cshub-backend-env" \
              -e BACKEND_URL="http://cshub-backend-env:9037" \
              -e PLAY_SECRET_KEY="${{ secrets.PLAY_FRONTEND_SECRET_KEY }}" \
              cmusvsc/smu_cshub:cshub-frontend-env \
              /app/basicframework-1.6.1-SNAPSHOT/bin/basicframework \
              -Dplay.http.secret.key="${{ secrets.PLAY_FRONTEND_SECRET_KEY }}" \
              -Dhttp.port=9036 \
              -Dhttp.address=0.0.0.0

            docker run -d \
              -p 9037:9037 \
              --name cshub-backend-env \
              --network cshub-network \
              -v /home/ubuntu/beichenh/scihub/backend-dist:/app \
              -e PLAY_SECRET_KEY="${{ secrets.PLAY_BACKEND_SECRET_KEY }}" \
              -e DB_URL="jdbc:mysql://cshub.cvqmoymkg5l2.us-east-2.rds.amazonaws.com:3306/old_cshub" \
              cmusvsc/smu_cshub:cshub-backend-env \
              /app/basicframework-1.0-SNAPSHOT/bin/basicframework \
              -Dplay.http.secret.key="${{ secrets.PLAY_BACKEND_SECRET_KEY }}" \
              -Dhttp.port=9037 \
              -Dhttp.address=0.0.0.0

            sudo docker image prune -a -f
