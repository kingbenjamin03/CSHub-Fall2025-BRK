@(project: Project)
@import helper._
@import models._
    @import models.Project

@scripts = {
    <style>
            tr {
                border-bottom: none;
            }
            td {
                text-align: center;
            }
            .ql-editor strong{
                font-weight:bold;
            }
            #editor {
                height: 375px;
            }
    </style>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/database_field_length.js")'></script>
    <script type="text/javascript" src='@routes.Assets.at("javascripts/field_validation_helper.js")'></script>

    <script type="text/javascript">
            count = 0;
            delc = 0;
            var originCreator;
            countImagesInDescription = @project.getNextImageIndex;
            var quill;
            function checkCreator() {
                $("#warningModal").modal("open");
                $("#challengeCreatorMsg").text("");
            }
            $(document).ready(function () {
                /**
                 * This portion defines all the (non)required fields that need validation on max lengths and special
                 * characters, as well as URL validity.
                 */
                validateField("memberName", "memberNameMsg", "varChar255", true);
                validateField("email", "emailMsg", "varChar255", true);
                validateField("title", "titleMsg", "varChar500", true);
                validateField("location", "locationMsg", "varChar200", true);
                validateField("goals", "goalsMsg", "varChar1000", true);
                validateField("tech", "techMsg", "varChar500", false);
                validateNoneRequiredUrl('github', 'githubMsg', 'varChar500');
                validateNoneRequiredUrl('team_page', 'team_pageMsg', 'varChar500');
                validateNoneRequiredUrl('video', 'videoMsg', 'varChar500');
                /****************************** End of Validation Portion **********************************************/

                originCreator = '@project.getSponsorContact.getId';
                $("#cancel-change-creator").click(function () {
                    $("#projectCreator").val(originCreator);
                })
                $("#confirm-change-creator").click(function () {
                    originCreator = $("#projectCreator").val();
                })

                quill = new Quill('#editor', {
                    modules: {
                        toolbar: [
                            [{ 'font': [] }],
                            [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
                            ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
                            [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                            ['blockquote'],

                            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                            [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
                            [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
                            [{ 'direction': 'rtl' }],                         // text directio
                            [{ 'align': [] }],
                            ['link', 'image']
                        ]
                    },
                    placeholder: 'Enter project description...',
                    theme: 'snow'
                });

                var limit = projectDescriptionMaxLength;
                quill.on('text-change', function (delta, old, source) {
                    if (quill.getLength() > limit+1) {
                        document.getElementById("descriptionMsg").innerHTML = "Field should be no longer than "+ limit +" characters";
                    }else{
                        document.getElementById("descriptionMsg").innerHTML = "";
                    }
                });

                quill.clipboard.dangerouslyPasteHTML(entityToString());
              //  $("#description").val();
                $("#addPanel").hide();
                $("#previewPanel").hide();
                if($("#showImg").attr("src") == "") {
                    $("#projectPreview").hide();
                }
                $("#showPanel").click(function () {
                    var panel = document.getElementById("addPanel");
                    if (panel.style.display == "none") {
                        $("#btnName").attr("style", "transform:rotate(-45deg);transition:transform 0.3s linear;");
                        $("#buttonText").text("Close Window");
                    }
                    else {
                        $("#btnName").attr("style", "transform:rotate(0deg);transition:transform 0.3s linear;");
                        $("#buttonText").text("Add Members");
                        document.getElementById("memberName").value = "";
                        document.getElementById("email").value = "";
                        document.getElementById("email").classList.remove("invalid");
                        document.getElementById("memberName").classList.remove("invalid");
                    }
                    $("#addPanel").slideToggle();

                });


                //preview the updated image
                $("#addmember").click(function changepic() {
                    if (document.getElementById("memberName").value.trim().length==0){
                        document.getElementById("memberName").classList.add("invalid");
                    }
                    if (document.getElementById("email").value.trim().length==0){
                        document.getElementById("email").classList.add("invalid");
                    }
                    // document.getElementById("email").value.trim().length()==0;
                    var isName = document.getElementById("memberName").classList.contains("invalid") ? false : true;
                    var isEmail = document.getElementById("email").classList.contains("invalid") ? false : true;

                    if(!isName || !isEmail) return;
                    if (document.getElementById("photo").value == "") {
                        var url = "../../../../assets/images/person.jpg";
                        showPreview(url);
                        return;
                    }
                    var reads = new FileReader();
                    f = document.getElementById("photo").files[0];
                    reads.readAsDataURL(f);
                    reads.onload = function (e) {
                        showPreview(this.result);

                    };
                });
                document.body.scrollTop = document.documentElement.scrollTop = 0;
            });

            function entityToString(){
                var div=document.createElement('div');
                @if(project.getDescription!=null){
                    div.innerHTML = "@project.getDescription";
                }
                var res=div.innerText||div.textContent;
                return res;
            }

            function getHTML() //display current HTML
            {
                if(document.getElementById("descriptionMsg").innerText.length != 0)
                    return false;
                console.log(Number.isInteger('fjidsao'));
                //console.log("isnan:" + isNaN($("#challengeCreator").text());
                var cid = $("#challengeCreator").val()
                console.log("cid" + $("#challengeCreator").val());
                console.log("typeof" + typeof($("#challengeCreator").val()));

                if(isNaN(cid)){
                    //document.getElementById(urlMsgId).setAttribute('data-error', msg);
                    console.log("cidddMSg:" + $("#challengeCreatorMsg").text())
                    $("#challengeCreatorMsg").text("Please specify correct id format");

                    return false;
                }
                exist = false;
                $.ajax({
                    url: "/user/allUserIds",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    async: false,
                    type: "GET"
                }).done(function (data) {
                    console.log("data:" + data)
                    console.log("id:" + cid)
                    for(i in data){
                        console.log(Number(data[i]) + "," + Number(cid))
                        if(Number(data[i]) == Number(cid)){
                            exist = true;
                            console.log("loop:" + exist);
                        }
                    }

                });
                console.log("out" + exist)
                if(!exist){
                    $("#challengeCreatorMsg").text("This user does not exist!");
                    return false;
                }
                $("#editor").find("img").each(function () {
                   if($(this).attr("width") == null) {
                       // If this is a new image
                       var img = this;
                       var dataurl = $(this).attr("src");
                       var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                       while (n--) {
                           u8arr[n] = bstr.charCodeAt(n);
                       }
                       var f = new File([u8arr], "file", {type: mime});
                       var fd = new FormData();
                       fd.append('file', f);
                       countImagesInDescription ++;
                       $.ajax({
                           url: "/project/uploadDescriptionImg/@project.getId/" + (countImagesInDescription-1) ,
                           data: fd,
                           contentType: false,
                           dataType: "text",
                           processData: false,
                           async: false,
                           type: "POST",
                           success: function (data) {
                               console.log(data);
                               $(img).attr("src", data);
                               $(img).attr("width", "50%");
                           },
                           error: function (msg) {
                               console.log("123123123");
                           }
                       });
                   }
               });

                var ajaxflag = true;
                var parentProjectId = $("#parentProjectId").val();
                if(parentProjectId !== "0") {
                    $.ajax({
                        url: "/project/checkParentProject/" + parentProjectId,
                        async: false,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        type: "GET",
                        success: function (data) {
                            var response = data;
                            console.log(data);
                            if ('badFormat' in response) {
                                console.log(response['badFormat']);
                                $("#parentProjectIdMsg").text(response['badFormat']);
                                ajaxflag = false;
                            } else {
                                if ('notExisted' in response) {
                                    $("#parentProjectIdMsg").text(response['notExisted']);
                                    ajaxflag = false;
                                } else {

                                }

                            }
                        }
                    });
                }
                if(!ajaxflag){
                    return false;
                }

               var html = quill.root.innerHTML;
               $("#description").val(html);
               $("#countImagesInDescription").val(countImagesInDescription);




                return true;
            }

            function showProPreview(obj) {
                if($("#showImg").attr("src") == "") {
                    $("#deleteBtn").hide();
                }
                else {
                    $("#deleteBtn").show();
                    //$('#previewMsg').text("");
                }
                    var panel = document.getElementById("previewPanel");
                    if (panel.style.display == "none") {
                        $(obj).text("Close Preview");
                    }
                    else {
                        $(obj).text("Preview Or Delete Picture");
                    }
                    $("#previewPanel").slideToggle();

            }

            function deleteMember(obj) {
                var tr  = $(obj).parent().parent();
                if(tr.attr("id") != null) {
                    tr.append("<td style='display: none;' > <input name ='delete" + delc + "' value='" + tr.attr("id") + "'></td>")
                    //tr.attr("name", "delete" + delc);
                    delc++;
                    $("#delc").val(delc);
                    tr.hide();
                }
                else tr.remove();
            }
            function showPreview(url) {
                if($("#memberName").val() == ""){
                    $("#msg").text("Member Name cannot be null.");
                    document.getElementById("addmember").disabled = true;
                    return;
                }
                $("#msg").text("");
                document.getElementById("addmember").disabled = false;
                var appendItem = "<tr><td><img src=\"" + url + "\" height='35px' style=\"width:35px;border-radius:50%;\"</td>" +
                        "<td>" + $("#memberName").val() + "<input type=\"text\" name='member" + count + "' id='member" + count + "' value=\""+ $("#memberName").val() +"\" style=\"display: none;\"></td>" +
                        "<td>" + $("#email").val() + "<input type=\"text\" name='email" + count + "' id='email" + count + "' value=\""+ $("#email").val() +"\" style=\"display: none;\"></td>" +
                        "<td><a href='javascript:void(0)' onclick='deleteMember(this)'><i style='color:red;' class=\"material-icons\">delete</i></a></td><td id='clone"+count+"'></td></tr>";
                $("#previewTable").append(appendItem);
                var td = $("#clone" + count);
                var obj = $("#photo").clone();
                obj.attr("id", "photo" + count);
                obj.attr("name", "photo" + count);
                td.append(obj);
                td.attr("style","display:none;");
                count++;
                $("#count").val(count);
                $("#memberName").val("");
                $("#email").val("");
                $("#showpath").val("");
                $("#photo").val("");
            }

            //preview the updated image
            function changProjectPic() {
                if(document.getElementById("picture").value == "") return;
                var reads = new FileReader();
                f = document.getElementById("picture").files[0];
                reads.readAsDataURL(f);
                reads.onload = function(e) {
                    document.getElementById('showImg').src = this.result;
                    $('#record').val("update");
                    $('#previewMsg').text("This is the preview image. You need to click \"UPDATE\" button below if you want to save the changes.");
                    $("#deleteBtn").show();
                    $("#projectPreview").show();
                };
            }

            function deleteImg() {
                document.getElementById('showImg').src = "";
                $('#record').val("delete");
                $("#deleteBtn").hide();
                $("#projectPreview").hide();
                showProPreview("#projectPreview");
                $('#previewMsg').text("The image is deleted. You need to click \"UPDATE\" button below if you want to save the changes.");
            }

            function deletePDF() {
                document.getElementById('showImg').src = "";
                $('#pdfRecord').val("delete");
                $("#pdfDeleteBtn").hide();
                $("#pdfDownload").hide();
                $('#pdfPreviewMsg').text("The PDF is deleted. You need to click \"UPDATE\" button below if you want to save the changes.");
            }

            function markAsPrivate() {

            }


    </script>
}

@main("Project Edit", scripts) {

    <link href='@routes.Assets.at("stylesheets/quill.snow.css")'
    rel="stylesheet" />
    <script type="text/javascript" src='@routes.Assets.at("javascripts/plugins/quill.js")'></script>

    <div class="container">
        <div class="row">
            <div class="col  s12 m10 offset-m1">
                <div class="card-panel">
                    <h4 class="center form-signin-heading" align="center">
                        Edit Project Information</h4>
                    <div id="warningModal" class="modal">
                        <div class="modal-content">
                            <h5 style="color: red">Warning!</h5>
                            <p style="font-weight: bold">Do you really want to change the creator of this project?
                                Please note that after this change, You <span style="color: red">
                                MAY NOT</span> edit this project again.</p>
                        </div>
                        <div class="modal-footer">
                            <a id="cancel-change-creator" class="modal-close waves-effect waves-green btn-flat">
                                Cancel</a>
                            <a id="confirm-change-creator"
                            class="modal-close waves-effect waves-green btn-flat">Confirm</a>
                        </div>
                    </div>
                    <form class="form-signin" enctype="multipart/form-data" id="editProjectForm" method="post" onsubmit="return getHTML()" action="@routes.ProjectController.projectEditPOST(project.getId)">
                        <div id="hiddenDiv" style="display: none;">
                            <input name="id" id="id" class="validate" value="@project.getId">
                            <input name="isActive" id="isActive" class="validate" value="@project.getIsActive">
                            <input name="isPopular" id="isPopular" class="validate" value="@project.getIsPopular">
                            <input name="popularRanking" id="popularRanking" class="validate" value="@project.getPopularRanking">
                            <input name="authentication" id="authentication" class="validate" value="@project.getAuthentication">
                            <input name="accessTimes" id="accessTimes" class="validate" value="@project.getAccessTimes">
                            <input name="nextImageIndex" id="nextImageIndex" class="validate" value="@project.getNextImageIndex">
                        </div>
                        <div class="row">
                            <div class="input-field col s12">
                                <input
                                type="text" name="title" id="title" class="validate" value="@project.getTitle" required>
                                <label for="title">Title* </label>
                                <span id="titleMsg" class="helper-text" data-error=""></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-field col s12">
                                <input type="text" name="goals" id="goals"  class="validate" required value="@project.getGoals">
                                <label for="goals">
                                    Goals* </label>
                                <span id="goalsMsg" class="helper-text" data-error=""></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-field col s12">
                                <input
                                type="text" name="location" id="location" value = "@project.getLocation"  class="validate" required>
                                <label for="location">
                                    Location* </label>
                                <span id="locationMsg" class="helper-text" data-error=""></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-field col s12">
                                <input
                                type="text" name="challengeCreator" id="challengeCreator" value = "@project.getSponsorContact.getId"  class="validate" onchange="checkCreator()" required>
                                <label for="location">
                                    Creator ID* (Change the ownership of this project. Please note that you will not have edit access if you transfer it out.)</label>
                                <span id="challengeCreatorMsg" style="color:red" class="helper-text" data-error=""></span>
                            </div>
                        </div>




                        <div class="row">
                            <div class="col s12">
                                <p style="color: #000;">
                                    Team Members: <a id="showPanel" class="close" href="javascript:void(0)" style="float: right;
                                    color: #000;"><i id="btnName" class="material-icons">
                                    add</i>
                                </a><a id="buttonText" style="float: right;">Edit Members</a></p>
                            </div>
                            <div id="addPanel" style="display: inline-block;">
                                <div class="col s1"><input type="text" name="count" id="count" value="0" style="display: none;"> </div>
                                <div class="col s1"><input type="text" name="delc" id="delc" value="0" style="display: none;"> </div>
                                <div class="col s10">
                                    <div class="input-field col s12">
                                        <input
                                        type="text" name="memberName" id="memberName" class="validate">
                                        <label for="memberName">Member Name</label>
                                        <span id="memberNameMsg" class="helper-text" data-error=""></span>
                                    </div>
                                    <div class="input-field col s12">
                                        <input type="email" name="email" id="email" class="validate">
                                        <label for="email">Email</label>
                                        <span id="emailMsg" class="helper-text" data-error=""></span>
                                    </div>
                                    <div class="file-field input-field col s12" >
                                        <div class="btn waves-effect waves-light blue darken-2" >
                                            <span >Upload Member Photo</span>
                                            <input type="file" accept=".jpeg,.png,.jpg" id="photo" name="photo">
                                        </div>
                                        <div class="file-path-wrapper">
                                            <input id="showpath" class="file-path validate" type="text">
                                        </div>
                                    </div>
                                    <div class="center input-field col s12">
                                        <a id="addmember" class="btn waves-effect waves-light blue darken-2">
                                            Add Member</a>

                                    </div>

                                </div>
                            </div>
                            <div class="col s12">
                                <Table class="highlight">
                                    <tbody id="previewTable">
                                        @if(project.getTeamMembers!=null) {
                                            @for(teamMember <- project.getTeamMembers) {
                                                <tr id="@teamMember.getId">
                                                    <td><img src="@teamMember.getAvatar" style="height: 35px;
                                                        width: 35px;
                                                        border-radius: 50%;"></img>
                                                    </td>
                                                    <td>@teamMember.getUserName()</td>
                                                    <td>@if(teamMember.getEmail() == "" || teamMember.getEmail() == null) {
                                                        -
                                                    } else {
                                                        @teamMember.getEmail()
                                                    }</td>
                                                    <td><a href='javascript:void(0)' onclick='deleteMember(this)'><i style='color: red;' class="material-icons">delete</i></a></td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </Table>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <input type="text" name="tech" id="tech" class="validate" value="@project.getTechnology">
                                <label for="tech">
                                    Technologies Used </label>
                                <span id="techMsg" class="helper-text" data-error=""></span>
                            </div>
                        </div>

                        <div class="row">

                            <div class="file-field input-field col s12" >
                                <div class="btn waves-effect waves-light blue darken-2" >
                                    <span >Change Project Picture</span>
                                    <input type="file" accept=".jpeg,.png,.jpg" id="picture" name="picture" onchange="changProjectPic()">
                                </div>
                                <div class="file-path-wrapper">
                                    <input class="file-path validate" type="text">
                                </div>

                                <div id="previewMsg" style="color:blue"></div>
                                @if(project.getImageUrl != null && project.getImageUrl != "") {
                                    <div>
                                        <a href="javascript:void(0)" id="projectPreview" onclick="showProPreview(this)">
                                            Preview Or Delete Picture</a>
                                    </div>
                                }
                            </div>
                            <div id="previewPanel" class="center" style="display: inline-block; text-align: center;">
                                <img id="showImg" src="@project.getImageUrl" width="360" height="350" style="height: auto;
                                    width: 80%;" >
                                <a id = "deleteBtn" class="btn waves-effect waves-light red darken-2" onclick="deleteImg()">
                                    Delete Picture</a>
                                <input id="record" name = "record" style="display: none;"/>
                            </div>
                        </div>

                        <div class="row">
                            <div class="file-field input-field col s12" >
                                <div class="btn waves-effect waves-light blue darken-2" >
                                    <span >Change Project PDF</span>
                                    <input type="file" accept=".pdf" id="pdf" name="pdf">
                                </div>
                                <div class="file-path-wrapper">
                                    <input class="file-path validate" type="text">
                                </div>
                                <div id="pdfPreviewMsg" style="color:blue"></div>
                                @if(project.getPdf != null && project.getPdf != "") {
                                        <a id="pdfDownload" href="@project.getPdf">
                                            Download Current Project PDF</a>
                                        <a id = "pdfDeleteBtn" class="right" href="#" style="color: red;" onclick="deletePDF()">
                                            <i class="material-icons">cross</i> Delete Current PDF</a>
                                }
                                <input id="pdfRecord" name = "pdfRecord" style="display: none;"/>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <input
                                type="text" name="video" id="video" value="@project.getVideoUrl" class="validate">
                                <label for="video">
                                    Video URL </label>
                                <span id="videoMsg" class="helper-text" data-error=""></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-field col s12">
                                <input
                                type="text" name="github" id="github" value = "@project.getGithubUrl" class="validate">
                                <label for="github">
                                    Github URL </label>
                                <span id="githubMsg" class="helper-text" data-error=""></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-field col s12">
                                <input
                                type="text" name="team_page" id="team_page" value = "@project.getTeamPageUrl">
                                <label for="team_page">
                                    Team Page URL </label>
                                <span id="team_pageMsg" class="helper-text" data-error=""></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <p style="color: #000;">Description: </p>
                                <div id="editor">
                                </div>
                                <span id="descriptionMsg" class="helper-text" data-error="" style="color: red; font-size: 12px"></span>
                                <textarea
                                class="materialize-textarea" name="description" style="display: none" id="description">
                                </textarea>

                            </div>
                        </div>

                        <div class="row">
                            <div class="input-field col s12">
                                <input
                                type="text" name="parentProjectId" id="parentProjectId" value = "@project.getParentProjectId" class="validate">
                                <label for="parentProjectId">
                                    Parent Project Id</label>
                                <span id="parentProjectIdMsg" class="helper-text" style="color:red" data-error=""></span>
                            </div>
                        </div>


                        <div class="actions row center">
                            <div class="input-field col s12">
                                <button type="submit" id="projectRegister" class="btn waves-effect waves-light blue darken-2">
                                    Update</button>
                                <a href="@routes.ProjectController.projectDetail(project.getId)" class="btn waves-effect waves-light red darken-2">
                                    Cancel</a>

                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

}
