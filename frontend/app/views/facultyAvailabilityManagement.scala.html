@import java.util
@(availabilitySlots: util.List[FacultyAvailability], scheduledInterviews: util.List[RAInterview], facultyId: Long)
@import helper._

@scripts = {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        .availability-slot {
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .scheduled-interview {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ff9800;
            background-color: #fff3e0;
        }
        .conflict-warning {
            color: #f44336;
            font-weight: bold;
        }
    </style>
    <script type="text/javascript">
        $(document).ready(function() {
            const DISPLAY_FORMAT = "m/d/y H:i"; // MM/DD/YY HH:MM (24h)

            function toIsoLike(dtStr) {
                if (!dtStr) return dtStr;
                // Convert backend-ish "YYYY-MM-DD HH:mm:ss" -> "YYYY-MM-DDTHH:mm:ss" for reliable parsing.
                return String(dtStr).trim().replace(" ", "T");
            }

            // Initialize Flatpickr for date and time ranges
            flatpickr("#addStartTime", {
                enableTime: true,
                dateFormat: DISPLAY_FORMAT,
                time_24hr: true,
                minDate: "today",
                minuteIncrement: 15,
                allowInput: true
            });

            flatpickr("#addEndTime", {
                enableTime: true,
                dateFormat: DISPLAY_FORMAT,
                time_24hr: true,
                minDate: "today",
                minuteIncrement: 15,
                allowInput: true
            });

            $(".delete-slot-btn").click(function() {
                var slotId = $(this).data("slot-id");
                if (confirm("Are you sure you want to delete this availability slot?")) {
                    $("#deleteSlotId").val(slotId);
                    $("#deleteSlotForm").submit();
                }
            });
        });
    </script>
}

@main("Manage Availability", scripts) {
    <div class="container">
        <div class="row">
            <div class="col s12 m10 offset-m1">
                <div class="card-panel">
                    <h4 class="center">Manage Your Availability</h4>

                    @if(flash.contains("error")) {
                        <div class="card-panel red lighten-5 red-text text-darken-4" style="padding: 10px; margin-top: 10px;">
                            @flash.get("error")
                        </div>
                    }
                    @if(flash.contains("success")) {
                        <div class="card-panel green lighten-5 green-text text-darken-4" style="padding: 10px; margin-top: 10px;">
                            @flash.get("success")
                        </div>
                    }

                    <div class="row">
                        <div class="col s12">
                            <h5>Add New Availability Slot</h5>
                            @helper.form(action = routes.RAJobController.manageAvailabilityPOST(), 'class -> "col s12") {
                                @helper.CSRF.formField
                                <input type="hidden" name="action" value="add">
                                
                                <div class="row">
                                    <div class="input-field col s12 m5">
                                        <input type="text" id="addStartTime" name="startTime" class="validate" required>
                                        <label for="addStartTime">Start Time (MM/DD/YY HH:MM)</label>
                                    </div>
                                    <div class="input-field col s12 m5">
                                        <input type="text" id="addEndTime" name="endTime" class="validate" required>
                                        <label for="addEndTime">End Time (MM/DD/YY HH:MM)</label>
                                    </div>
                                    <div class="input-field col s12 m2">
                                        <button type="submit" class="btn waves-effect waves-light green">
                                            Add Slot
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="row">
                        <div class="col s12">
                            <h5>Your Availability Slots</h5>
                            @if(availabilitySlots == null || availabilitySlots.isEmpty()) {
                                <p>No availability slots defined. Add slots above to make yourself available for interviews.</p>
                            } else {
                                @for(slot <- availabilitySlots) {
                                    @if(slot != null) {
                                        <div class="availability-slot">
                                            <div class="row">
                                                <div class="col s12 m8">
                                                    <strong>Start:</strong> @if(slot.getStartTime() != null) { @slot.getStartTime() } else { N/A }<br>
                                                    <strong>End:</strong> @if(slot.getEndTime() != null) { @slot.getEndTime() } else { N/A }<br>
                                                    <strong>Status:</strong> 
                                                    @if(slot.getIsAvailable()) {
                                                        <span class="green-text">Available</span>
                                                    } else {
                                                        <span class="red-text">Unavailable</span>
                                                    }
                                                </div>
                                                <div class="col s12 m4 right-align">
                                                    <button class="btn-small waves-effect waves-light red delete-slot-btn" 
                                                            data-slot-id="@slot.getId()">
                                                        Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    </div>

                    @if(scheduledInterviews != null && !scheduledInterviews.isEmpty()) {
                        <div class="row">
                            <div class="col s12">
                                <h5>Scheduled Interviews</h5>
                                <p>These interviews are already scheduled and may conflict with availability slots.</p>
                                @for(interview <- scheduledInterviews) {
                                    @if(interview != null) {
                                        <div class="scheduled-interview">
                                            <strong>Date & Time:</strong> @if(interview.getInterviewTime() != null) { @interview.getInterviewTime() } else { N/A }<br>
                                            <strong>Applicant:</strong> 
                                            @if(interview.getApplicant() != null) {
                                                @if(interview.getApplicant().getFirstName() != null) { @interview.getApplicant().getFirstName() }
                                                @if(interview.getApplicant().getLastName() != null) { @interview.getApplicant().getLastName() }
                                            } else {
                                                N/A
                                            }
                                            <br>
                                            <strong>Status:</strong> @if(interview.getStatus() != null) { @interview.getStatus() } else { N/A }<br>
                                            @if(interview.getId() > 0) {
                                                <a href="@routes.RAJobController.viewInterview(interview.getId())" class="btn-small waves-effect waves-light blue">View Details</a>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        </div>
                    }

                    <div class="row">
                        <div class="col s12 center">
                            <a href="@routes.RAJobController.rajobList(1, "")" class="btn waves-effect waves-light grey">
                                Back to RA Jobs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Slot Form (hidden) -->
    @helper.form(action = routes.RAJobController.manageAvailabilityPOST(), 'id -> "deleteSlotForm", 'class -> "col s12") {
        @helper.CSRF.formField
        <input type="hidden" name="action" value="delete">
        <input type="hidden" id="deleteSlotId" name="slotId" value="">
    }
}

