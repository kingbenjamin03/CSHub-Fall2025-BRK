@(technology: Technology)
@import helper._
@import models._
@import models.Technology

@scripts = {
<style>
    tr {
        border-bottom: none;
    }
    td {
        text-align: center;
    }
    .ql-editor strong{
        font-weight:bold;
    }
    #editor {
        height: 375px;
    }
</style>
<script type="text/javascript" src='@routes.Assets.at("javascripts/database_field_length.js")'></script>
<script type="text/javascript" src='@routes.Assets.at("javascripts/field_validation_helper.js")'></script>

<script type="text/javascript">
    count = 0;
    delc = 0;
    var originCreator;
    var quill;
    function checkCreator() {
        $("#warningModal").modal("open");
        $("#challengeCreatorMsg").text("");
    }
    $(document).ready(function () {
        /**
         * This portion defines all the (non)required fields that need validation on max lengths and special
         * characters, as well as URL validity.
         */
        validateField("memberName", "memberNameMsg", "varChar255", true);
        validateField("email", "emailMsg", "varChar255", true);
        validateField("title", "titleMsg", "varChar500", true);
        validateField("location", "locationMsg", "varChar200", true);
        validateField("goals", "goalsMsg", "varChar1000", true);
        validateField("tech", "techMsg", "varChar500", false);
        validateNoneRequiredUrl('github', 'githubMsg', 'varChar500');
        validateNoneRequiredUrl('team_page', 'team_pageMsg', 'varChar500');
        validateNoneRequiredUrl('video', 'videoMsg', 'varChar500');
        /****************************** End of Validation Portion **********************************************/



        quill = new Quill('#editor', {
            modules: {
                toolbar: [
                    [{ 'font': [] }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
                    ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
                    [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
                    ['blockquote'],

                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],      // superscript/subscript
                    [{ 'indent': '-1'}, { 'indent': '+1' }],          // outdent/indent
                    [{ 'direction': 'rtl' }],                         // text directio
                    [{ 'align': [] }],
                    ['link', 'image']
                ]
            },
            placeholder: 'Enter project description...',
            theme: 'snow'
        });

        var limit = technologyDescriptionMaxLength;
        quill.on('text-change', function (delta, old, source) {
            if (quill.getLength() > limit+1) {
                document.getElementById("descriptionMsg").innerHTML = "Field should be no longer than "+ limit +" characters";
            }else{
                document.getElementById("descriptionMsg").innerHTML = "";
            }
        });

        quill.clipboard.dangerouslyPasteHTML(entityToString());
        //  $("#description").val();
        $("#addPanel").hide();
        $("#previewPanel").hide();
        if($("#showImg").attr("src") == "") {
            $("#projectPreview").hide();
        }
        $("#showPanel").click(function () {
            var panel = document.getElementById("addPanel");
            if (panel.style.display == "none") {
                $("#btnName").attr("style", "transform:rotate(-45deg);transition:transform 0.3s linear;");
                $("#buttonText").text("Close Window");
            }
            else {
                $("#btnName").attr("style", "transform:rotate(0deg);transition:transform 0.3s linear;");
                $("#buttonText").text("Add Members");
                document.getElementById("memberName").value = "";
                document.getElementById("email").value = "";
                document.getElementById("email").classList.remove("invalid");
                document.getElementById("memberName").classList.remove("invalid");
            }
            $("#addPanel").slideToggle();

        });


        //preview the updated image
        $("#addmember").click(function changepic() {
            if (document.getElementById("memberName").value.trim().length==0){
                document.getElementById("memberName").classList.add("invalid");
            }
            if (document.getElementById("email").value.trim().length==0){
                document.getElementById("email").classList.add("invalid");
            }
            // document.getElementById("email").value.trim().length()==0;
            var isName = document.getElementById("memberName").classList.contains("invalid") ? false : true;
            var isEmail = document.getElementById("email").classList.contains("invalid") ? false : true;

            if(!isName || !isEmail) return;
            if (document.getElementById("photo").value == "") {
                var url = "../../../../assets/images/person.jpg";
                showPreview(url);
                return;
            }
            var reads = new FileReader();
            f = document.getElementById("photo").files[0];
            reads.readAsDataURL(f);
            reads.onload = function (e) {
                showPreview(this.result);

            };
        });
        document.body.scrollTop = document.documentElement.scrollTop = 0;
    });

    function entityToString(){
        var div=document.createElement('div');
    @if(technology.getShortDescription!=null){
            div.innerHTML = "@technology.getShortDescription";
        }
        var res=div.innerText||div.textContent;
        return res;
    }

    function getHTML() //display current HTML
    {
        if(document.getElementById("descriptionMsg").innerText.length != 0)
            return false;
        console.log(Number.isInteger('fjidsao'));
        //console.log("isnan:" + isNaN($("#challengeCreator").text());
        var cid = $("#challengeCreator").val()
        console.log("cid" + $("#challengeCreator").val());
        console.log("typeof" + typeof($("#challengeCreator").val()));

        if(isNaN(cid)){
            //document.getElementById(urlMsgId).setAttribute('data-error', msg);
            console.log("cidddMSg:" + $("#challengeCreatorMsg").text())
            $("#challengeCreatorMsg").text("Please specify correct id format");

            return false;
        }
        exist = false;
        $.ajax({
            url: "/user/allUserIds",
            headers: {
                'Content-Type': 'application/json'
            },
            async: false,
            type: "GET"
        }).done(function (data) {
            console.log("data:" + data)
            console.log("id:" + cid)
            for(i in data){
                console.log(Number(data[i]) + "," + Number(cid))
                if(Number(data[i]) == Number(cid)){
                    exist = true;
                    console.log("loop:" + exist);
                }
            }

        });
        console.log("out" + exist)
        if(!exist){
            $("#challengeCreatorMsg").text("This user does not exist!");
            return false;
        }
        $("#editor").find("img").each(function () {
            if($(this).attr("width") == null) {
                // If this is a new image
                var img = this;
                var dataurl = $(this).attr("src");
                var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                var f = new File([u8arr], "file", {type: mime});
                var fd = new FormData();
                fd.append('file', f);
                countImagesInDescription ++;
                $.ajax({
                    url: "/project/uploadDescriptionImg/@technology.getId/" + (countImagesInDescription-1) ,
                    data: fd,
                    contentType: false,
                    dataType: "text",
                    processData: false,
                    async: false,
                    type: "POST",
                    success: function (data) {
                        console.log(data);
                        $(img).attr("src", data);
                        $(img).attr("width", "50%");
                    },
                    error: function (msg) {
                        console.log("123123123");
                    }
                });
            }



        });

        var ajaxflag = true;
        var parentProjectId = $("#parentProjectId").val();
        if(parentProjectId !== "0") {
            $.ajax({
                url: "/project/checkParentProject/" + parentProjectId,
                async: false,
                headers: {
                    'Content-Type': 'application/json'
                },
                type: "GET",
                success: function (data) {
                    var response = data;
                    console.log(data);
                    if ('badFormat' in response) {
                        console.log(response['badFormat']);
                        $("#parentProjectIdMsg").text(response['badFormat']);
                        ajaxflag = false;
                    } else {
                        if ('notExisted' in response) {
                            $("#parentProjectIdMsg").text(response['notExisted']);
                            ajaxflag = false;
                        } else {

                        }

                    }
                }
            });
        }
        if(!ajaxflag){
            return false;
        }

        var html = quill.root.innerHTML;
        $("#description").val(html);
        $("#countImagesInDescription").val(countImagesInDescription);




        return true;
    }

    function showProPreview(obj) {
        if($("#showImg").attr("src") == "") {
            $("#deleteBtn").hide();
        }
        else {
            $("#deleteBtn").show();
            //$('#previewMsg').text("");
        }
        var panel = document.getElementById("previewPanel");
        if (panel.style.display == "none") {
            $(obj).text("Close Preview");
        }
        else {
            $(obj).text("Preview Or Delete Picture");
        }
        $("#previewPanel").slideToggle();

    }


    function deletePDF() {
        document.getElementById('showImg').src = "";
        $('#pdfRecord').val("delete");
        $("#pdfDeleteBtn").hide();
        $("#pdfDownload").hide();
        $('#pdfPreviewMsg').text("The PDF is deleted. You need to click \"UPDATE\" button below if you want to save the changes.");
    }

    function markAsPrivate() {

    }


</script>
}

@main("Technology Edit", scripts) {

<link href='@routes.Assets.at("stylesheets/quill.snow.css")'
      rel="stylesheet" />
<script type="text/javascript" src='@routes.Assets.at("javascripts/plugins/quill.js")'></script>

<div class="container">
    <div class="row">
        <div class="col  s12 m10 offset-m1">
            <div class="card-panel">
                <h4 class="center form-signin-heading" align="center">
                    Edit Technology Information</h4>
                <div id="warningModal" class="modal">
                    <div class="modal-content">
                        <h5 style="color: red">Warning!</h5>
                        <p style="font-weight: bold">Do you really want to change the creator of this project?
                            Please note that after this change, You <span style="color: red">
                                MAY NOT</span> edit this project again.</p>
                    </div>
                    <div class="modal-footer">
                        <a id="cancel-change-creator" class="modal-close waves-effect waves-green btn-flat">
                            Cancel</a>
                        <a id="confirm-change-creator"
                           class="modal-close waves-effect waves-green btn-flat">Confirm</a>
                    </div>
                </div>
                <form class="form-signin" enctype="multipart/form-data" id="editTechnologyForm" method="post" onsubmit="return getHTML()" action="@routes.TechnologyController.technologyEditPOST(technology.getId)">
                    <div id="hiddenDiv" style="display: none;">
                        <input name="id" id="id" class="validate" value="@technology.getId">
                        <input name="isActive" id="isActive" class="validate" value="@technology.getIsActive">
                        @*<input name="isPopular" id="isPopular" class="validate" value="@technology.getIsPopular">
                        <input name="popularRanking" id="popularRanking" class="validate" value="@technology.getPopularRanking">
                        <input name="authentication" id="authentication" class="validate" value="@technology.getAuthentication">
                        <input name="accessTimes" id="accessTimes" class="validate" value="@technology.getAccessTimes">*@
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input
                                    type="text" name="technologyTitle" id="technologyTitle" class="validate" value="@technology.getTechnologyTitle" required>
                            <label for="title">Title* </label>
                            <span id="technologyTitleMsg" class="helper-text" data-error=""></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input type="text" name="goals" id="goals"  class="validate" required value="@technology.getGoals">
                            <label for="goals">
                                Goals* </label>
                            <span id="goalsMsg" class="helper-text" data-error=""></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input
                                    type="text" name="shortDescription" id="shortDescription" value = "@technology.getShortDescription"  class="validate" required>
                            <label for="shortDescription">
                                Short Description* </label>
                            <span id="shortDescriptionMsg" class="helper-text" data-error=""></span>
                        </div>
                    </div>


                    <div class="row">
                        <div class="input-field col s12">
                            <input type="text" name="keywords" id="keywords" class="validate" value="@technology.getKeywords" class="validate" required>
                            <label for="keywords">
                                Keywords* </label>
                            <span id="keywordsMsg" class="helper-text" data-error=""></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                            <input type="text" name="fields" id="fields" class="validate" value="@technology.getFields" class="validate" required>
                            <label for="fields">
                                Fields* </label>
                            <span id="fieldsMsg" class="helper-text" data-error=""></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="file-field input-field col s12" >
                            <div class="btn waves-effect waves-light blue darken-2" >
                                <span >Change Representative Paper PDF</span>
                                <input type="file" accept=".pdf" id="pdf" name="pdf">
                            </div>
                            <div class="file-path-wrapper">
                                <input class="file-path validate" type="text">
                            </div>
                            <div id="pdfPreviewMsg" style="color:blue"></div>
                            @if(technology.getPdf != null && technology.getPdf != "") {
                            <a id="pdfDownload" href="@technology.getPdf">
                                Download Current Representative Paper PDF</a>
                            <a id = "pdfDeleteBtn" class="right" href="#" style="color: red;" onclick="deletePDF()">
                                <i class="material-icons">cross</i> Delete Current PDF</a>
                            }
                            <input id="pdfRecord" name = "pdfRecord" style="display: none;"/>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-field col s12">
                            <input
                                    type="text" name="representativePaperURL" id="representativePaperURL" value="@technology.getRepresentativePaperURL" class="validate">
                            <label for="representativePaperURL">
                                Representative Paper URL </label>
                            <span id="representativePaperURLMsg" class="helper-text" data-error=""></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input
                                    type="text" name="teamMembers" id="teamMembers" value = "@technology.getTeamMembers" class="validate">
                            <label for="teamMembers">
                                Team Members </label>
                            <span id="githubMsg" class="helper-text" data-error=""></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12">
                            <input
                                    type="text" name="pIName" id="pIName" value = "@technology.getPIName" class="validate" required>
                            <label for="pIName">
                                PI Name* </label>
                            <span id="pINameMsg" class="helper-text" data-error=""></span>
                        </div>
                    </div>


                    <div class="row">
                        <div class="input-field col s12">
                            <textarea type="text" style="height: 200px;
                                word-wrap: break-word; margin-top: 10px;" id="longDescription" placeholder="" name="longDescription"  onchange="validateTextarea('longDescription', 'technology', 'addTechnology')">@technology.getLongDescription</textarea>
                            <label for="longDescription">Long Description</label>
                            <span id="longDescriptionMsg" class="helper-text" data-error="" style="color: red; font-size: 12px"></span>
                        </div>
                    </div>

                    <div class="actions row center">
                        <div class="input-field col s12">
                            <button type="submit" id="technologyRegister" class="btn waves-effect waves-light blue darken-2">
                                Update</button>
                            <a href="@routes.TechnologyController.technologyDetail(technology.getId)" class="btn waves-effect waves-light red darken-2">
                                Cancel</a>

                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

}
